name: pr
on:
  pull_request:

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for actions/checkout

jobs:
  test:
    uses: ./.github/workflows/test.yml
  e2e:
    uses: ./.github/workflows/e2e.yml
  build-and-push:
    uses: ./.github/workflows/build-and-push.yml
    with:
      tag: pr-${{ github.sha }}
  deploy-pr-version:
    runs-on: ubuntu-latest
    needs: [build-and-push]
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-southeast-2
          role-to-assume: arn:aws:iam::340752831962:role/deploy
      - name: deploy lambda
        id: deploy-lambda
        env:
          IMAGE_URI: ${{ steps.build-and-push.outputs.image-uri }}
          FUNCTION_ALIAS: ${{ github.sha }}
        run: |
          NEW_VERSION=$( \
            aws lambda update-function-code \
            --function-name app \
            --image-uri "$IMAGE_URI" \
            --publish \
            --output text --query "Version" \
          )
          aws lambda wait published-version-active \
            --function-name "app:$NEW_VERSION"
          aws lambda create-alias \
            --function-name app \
            --name "$FUNCTION_ALIAS" \
            --function-version $NEW_VERSION
          aws lambda update-alias \
            --function-name app \
            --name "$FUNCTION_ALIAS" \
            --function-version $NEW_VERSION
          FUNCTION_URL=$( \
            aws lambda get-function-url-config \
            --function-name app \
            --qualifier "$FUNCTION_ALIAS" \
            --output text --query "FunctionUrl" \
          )
          echo "lambda-version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "function-url=$FUNCTION_URL" >> "$GITHUB_OUTPUT"


